<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>5-FU â€” Assessment Form</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    .grade-bar{ display:flex; gap:.4rem; flex-wrap:wrap; }
    .grade-btn{
      border:1px dashed rgba(255,255,255,0.18); background:var(--input-bg); color:var(--text);
      padding:.35rem .55rem; border-radius:999px; font-weight:700; font-size:.9rem; cursor:pointer;
    }
    .grade-btn.active{ border-style:solid; background:rgba(255,255,255,0.06); color:#e5f7ff; border-color:var(--primary); }

    .form-row{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-1{ grid-column: span 1 / span 1; }
    .col-2{ grid-column: span 2 / span 2; }
    .col-3{ grid-column: span 3 / span 3; }
    .col-4{ grid-column: span 4 / span 4; }
    .col-6{ grid-column: span 6 / span 6; }
    .col-8{ grid-column: span 8 / span 8; }
    .col-12{ grid-column: 1 / -1; }
    @media (max-width: 960px){
      .col-1,.col-2,.col-3,.col-4,.col-6,.col-8{ grid-column: 1 / -1; }
    }

    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:8px; position:sticky; top:-1px; z-index:40; background:linear-gradient(180deg, var(--surface), transparent); padding-bottom:8px; }
    .tab-btn{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border);
      background:var(--pill-bg); color:var(--text); cursor:pointer; font-weight:600; font-size:13px;
    }
    .tab-btn[aria-selected="true"]{ background:var(--primary); color:#0F2A21; border-color:transparent; }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    .highlight label{ color:#FFD877; }
    .highlight input{ box-shadow: 0 0 0 2px rgba(255,186,0,0.18); border-color: rgba(255,186,0,0.45); }

    .icon{ width:16px; height:16px; display:inline-block; vertical-align:-3px; margin-right:6px; }

    .table-card .card-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }

    /* ===== Resizable (Ø§Ø³ØªÙØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„) ===== */
    .resizable{
      resize: both;
      overflow: auto;
      min-width: 320px;
      min-height: 260px;
      max-width: 150%;
      max-height: 90vh;
      position: relative;
    }
    .resizable::after{
      content: "â†˜ drag to resize";
      position: absolute; right: 10px; bottom: 8px;
      font-size: 11px; color: var(--text-dim);
      pointer-events: none; user-select: none;
    }

    /* ===== Draggable (Ø®Ø§Øµ Ø¨Ù€ Saved assessments ÙÙ‚Ø·) ===== */
    /* Ù†Ø®Ù„ÙŠ Ø§Ù„Ù€container Ù…Ø±Ø¬Ø¹ÙŠØ© Ù„Ù„ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·Ù„Ù‚ */
    main.container{ position: relative; }
    /* Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·Ù„Ù‚ Ù„Ù„ÙƒØ§Ø±Ø¯ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© */
    #saved-card.drag-abs{
      position: absolute;
      z-index: 60;
    }
    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨: Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    #saved-card .card-title{ cursor: move; user-select: none; }
    /* Ù†Ø³Ø¨Ø© Ø¸Ù„ Ø®ÙÙŠÙØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨ */
    #saved-card.dragging{ box-shadow: 0 12px 36px rgba(0,0,0,0.45); }
  </style>
</head>
<body>
  <header class="app-header container">
    <h1 class="text-lg">Assessment Form</h1>
    <div class="subtitle muted">Record patient toxicity and follow-up</div>
  </header>

  <main class="container">
    <!-- ============== FORM CARD ============== -->
    <section class="card resizable" id="form-card" data-resize-key="form-card-size">
      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Assessment Sections">
        <button class="tab-btn" role="tab" aria-selected="true"  aria-controls="tab-patient"   id="tabbtn-patient">ğŸ§¾ Patient</button>
        <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-regimen"   id="tabbtn-regimen">ğŸ—“ï¸ Regimen & Dates</button>
        <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tox"       id="tabbtn-tox">ğŸ§ª Toxicity</button>
        <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-decisions" id="tabbtn-decisions">âš–ï¸ Decisions & Notes</button>
      </div>

      <form id="assessment-form" novalidate autocomplete="on">
        <!-- ========== Patient ========== -->
        <div class="tab-panel active" id="tab-patient" role="tabpanel" aria-labelledby="tabbtn-patient">
          <div class="form-row">
            <div class="form-group col-4">
              <label for="patient_name"><span class="icon">ğŸ‘¤</span>Name</label>
              <input id="patient_name" name="patient_name" type="text" placeholder="e.g., Full name" autocomplete="name" />
            </div>
            <div class="form-group col-3">
              <label for="patient_id"><span class="icon">#</span>ID</label>
              <input id="patient_id" name="patient_id" type="text" placeholder="e.g., MRN" autocomplete="off" />
            </div>
            <div class="form-group col-3">
              <label for="patient_phone"><span class="icon">ğŸ“</span>Phone</label>
              <input id="patient_phone" name="patient_phone" type="tel" placeholder="+972... or 05x-xxxxxxx" autocomplete="tel" />
            </div>
            <div class="form-group col-1">
              <label for="sex">Sex</label>
              <select id="sex" name="sex" autocomplete="off">
                <option value="">â€”</option><option value="M">M</option><option value="F">F</option>
              </select>
            </div>
            <div class="form-group col-1">
              <label for="age">Age</label>
              <input id="age" name="age" type="number" inputmode="numeric" placeholder="e.g., 55" autocomplete="off" />
            </div>
          </div>

          <hr class="divider" />

          <div class="section-title">
            <h3>ğŸ§¬ Cancer &amp; Stage</h3>
          </div>
          <div class="form-row">
            <div class="form-group col-6">
              <label for="diagnosis_select">Cancer type</label>
              <select id="diagnosis_select" autocomplete="off">
                <option value="">Selectâ€¦</option>
                <option>Colon</option><option>Rectal</option><option>Gastric</option>
                <option>Pancreatic</option><option>Breast</option><option>Head &amp; Neck</option>
                <option>Lung</option><option>Other</option>
              </select>
              <input id="diagnosis_other" type="text" placeholder="Type cancerâ€¦" style="display:none;margin-top:.4rem" />
              <input id="diagnosis" name="diagnosis" type="hidden" />
            </div>

            <div class="form-group col-3">
              <label for="stage">Stage</label>
              <select id="stage" name="stage" autocomplete="off">
                <option value="">Selectâ€¦</option><option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ========== Regimen & Dates ========== -->
        <div class="tab-panel" id="tab-regimen" role="tabpanel" aria-labelledby="tabbtn-regimen">
          <div class="section-title">
            <h3>ğŸ§ª Regimen &amp; Dates</h3>
          </div>
          <div class="form-row">
            <div class="form-group col-8">
              <label for="regimen">Regimen</label>
              <input id="regimen" name="regimen" type="text" placeholder="e.g., FOLFOX, CAPOX, 5FU infusion" autocomplete="off" />
            </div>
            <div class="form-group col-2">
              <label for="assessment_date">Assessment Date</label>
              <input id="assessment_date" name="assessment_date" type="date" autocomplete="off" />
            </div>
            <div class="form-group col-2">
              <label for="cycle">Cycle</label>
              <input id="cycle" name="cycle" type="number" inputmode="numeric" placeholder="e.g., 2" autocomplete="off" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-4">
              <label for="first_date_5fu">1st date 5FU</label>
              <input id="first_date_5fu" name="first_date_5fu" type="date" autocomplete="off" />
            </div>
          </div>

          <script>
            (function(){
              var el = document.getElementById('first_date_5fu');
              if (el && !el.value) {
                var d = new Date();
                var pad = function(n){ return String(n).padStart(2,'0'); };
                el.value = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
              }
            })();
          </script>

          <div class="form-row">
            <div class="form-group col-6 highlight">
              <label for="followup_due">Next phone follow-up</label>
              <div class="flex items-center gap-2">
                <input id="followup_due" name="followup_due" type="date" autocomplete="off" />
                <button type="button" class="btn" data-nw="1">1w</button>
                <button type="button" class="btn" data-nw="2">2w</button>
                <button type="button" class="btn" data-nw="3">3w</button>
                <button type="button" class="btn" data-nw="4">4w</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ========== Toxicity (CTCAE v5.0) ========== -->
        <div class="tab-panel" id="tab-tox" role="tabpanel" aria-labelledby="tabbtn-tox">
          <div class="section-title">
            <h3>ğŸ§¯ Toxicity (CTCAE v5.0)</h3>
          </div>

          <div class="form-row">
            <div class="form-group col-6">
              <label for="toxicity_found">Toxicity found?</label>
              <select id="toxicity_found" name="toxicity_found" autocomplete="off">
                <option value="">â€”</option><option>No</option><option>Yes</option>
              </select>
            </div>
            <div class="form-group col-6">
              <label for="toxicity">Overall grade</label>
              <input id="toxicity" name="toxicity" type="text" readonly placeholder="Auto (max of below)" />
            </div>
          </div>

          <!-- Mucositis -->
          <div class="form-row">
            <div class="form-group col-12">
              <label>Mucositis</label>
              <div class="grade-bar" data-target="mucositis_grade">
                <button type="button" class="grade-btn" data-grade="G0">G0</button>
                <button type="button" class="grade-btn" data-grade="G1">G1</button>
                <button type="button" class="grade-btn" data-grade="G2">G2</button>
                <button type="button" class="grade-btn" data-grade="G3">G3</button>
                <button type="button" class="grade-btn" data-grade="G4">G4</button>
              </div>
              <select id="mucositis_grade" name="mucositis_grade" style="display:none">
                <option value="">â€”</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option>
              </select>
            </div>
          </div>

          <!-- Diarrhea -->
          <div class="form-row">
            <div class="form-group col-12">
              <label>Diarrhea</label>
              <div class="grade-bar" data-target="diarrhea_grade">
                <button type="button" class="grade-btn" data-grade="G0">G0</button>
                <button type="button" class="grade-btn" data-grade="G1">G1</button>
                <button type="button" class="grade-btn" data-grade="G2">G2</button>
                <button type="button" class="grade-btn" data-grade="G3">G3</button>
                <button type="button" class="grade-btn" data-grade="G4">G4</button>
              </div>
              <select id="diarrhea_grade" name="diarrhea_grade" style="display:none">
                <option value="">â€”</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option>
              </select>
            </div>
          </div>

          <!-- Neutropenia -->
          <div class="form-row">
            <div class="form-group col-12">
              <label>Neutropenia</label>
              <div class="grade-bar" data-target="neutropenia_grade">
                <button type="button" class="grade-btn" data-grade="G0">G0</button>
                <button type="button" class="grade-btn" data-grade="G1">G1</button>
                <button type="button" class="grade-btn" data-grade="G2">G2</button>
                <button type="button" class="grade-btn" data-grade="G3">G3</button>
                <button type="button" class="grade-btn" data-grade="G4">G4</button>
              </div>
              <select id="neutropenia_grade" name="neutropenia_grade" style="display:none">
                <option value="">â€”</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option>
              </select>
            </div>
          </div>

          <!-- Other toxicity -->
          <div class="form-row">
            <div class="form-group col-8">
              <label for="other_tox_name">Other toxicity (name)</label>
              <input id="other_tox_name" name="other_tox_name" type="text" placeholder="e.g., Hand-Foot" autocomplete="off" />
            </div>
            <div class="form-group col-4">
              <label for="other_tox_grade">Other toxicity grade</label>
              <select id="other_tox_grade" name="other_tox_grade" autocomplete="off">
                <option value="">â€”</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ========== Decisions & Notes ========== -->
        <div class="tab-panel" id="tab-decisions" role="tabpanel" aria-labelledby="tabbtn-decisions">
          <div class="section-title">
            <h3>âš–ï¸ Treatment decisions related to toxicity</h3>
          </div>
          <div class="form-row">
            <div class="form-group col-3">
              <label for="hospitalization_due_tox">Hospitalization Due to Toxicity</label>
              <select id="hospitalization_due_tox" name="hospitalization_due_tox" autocomplete="off">
                <option value="">â€”</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="form-group col-2">
              <label for="delay">Delay</label>
              <select id="delay" name="delay" autocomplete="off">
                <option value="">â€”</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="form-group col-2">
              <label for="stop">Stop</label>
              <select id="stop" name="stop" autocomplete="off">
                <option value="">â€”</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="form-group col-3">
              <label for="dose_modification">Dose modification</label>
              <select id="dose_modification" name="dose_modification" autocomplete="off">
                <option value="">â€”</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="form-group col-2">
              <label for="dose_reduction_pct">Dose reduction (%)</label>
              <input id="dose_reduction_pct" name="dose_reduction_pct" type="number" min="0" max="100" step="1" placeholder="e.g., 25" />
            </div>
          </div>

          <hr class="divider" />

          <div class="form-row">
            <div class="form-group col-12">
              <label for="notes"><span class="icon">ğŸ“</span>Notes</label>
              <textarea id="notes" name="notes" rows="4" placeholder="Free textâ€¦" autocomplete="off"></textarea>
            </div>
          </div>
        </div>
      </form>

      <div class="form-sticky-actions">
        <button type="button" id="btn-save" class="btn btn-primary cta">ğŸ’¾ Save Entry</button>
        <button type="reset"  id="btn-reset" class="btn">â†º Reset Form</button>
      </div>
    </section>

    <!-- ============== SAVED TABLE (Draggable + Resizable) ============== -->
    <section class="card table-card resizable" id="saved-card" data-resize-key="saved-card-size" data-pos-key="saved-card-pos">
      <div class="card-title" id="saved-drag-handle">
        <div class="flex items-center gap-2">
          <span class="badge">Saved assessments</span>
        </div>
      </div>
      <div id="saved-assessments" class="table-host"></div>
    </section>
  </main>

  <!-- ============== Scripts (Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨) ============== -->
  <script src="app-data.js"></script>
  <script src="ctcae.js"></script>
  <script src="app-utils.js"></script>
  <script src="app-extensions.js"></script>

  <script src="app-tox-helpers.js"></script>
  <script src="app-toxrow.js"></script>

  <script src="app-sheets.js"></script>
  <script src="app-csv.js"></script>
  <script src="app-dom-helpers.js"></script>
  <script src="app-phone.shared.js"></script>
  <script src="app-phone.skeleton.js"></script>
  <script src="app-phone.dpyd.js"></script>
  <script src="app-phone.prevvisit.js"></script>
  <script src="app-phone.table.js"></script>
  <script src="app-phone.events.js"></script>
  <script src="app-phone.js"></script>
  <script src="app-diagnostics.js"></script>
  <script src="app-init.js"></script>

  <!-- Ù…Ø²Ø§Ù…Ù†Ø© grade-badges + ØªØ¨ÙˆÙŠØ¨Ø§Øª + Defaults + Ù‚ÙÙ„ G0 + Ø£Ø²Ø±Ø§Ø± 1w..4w -->
  <script>
    (function(){
      'use strict';

      function syncBar(bar){
        var targetId = bar.getAttribute('data-target');
        var select = document.getElementById(targetId);
        if (!select) return;
        bar.querySelectorAll('.grade-btn').forEach(function(btn){
          btn.classList.toggle('active', select.value === btn.dataset.grade);
        });
      }
      function pick(bar, grade){
        var targetId = bar.getAttribute('data-target');
        var select = document.getElementById(targetId);
        if (!select) return;
        select.value = grade;
        select.dispatchEvent(new Event('input', {bubbles:true}));
        select.dispatchEvent(new Event('change', {bubbles:true}));
        syncBar(bar);
      }
      function initBars(){
        document.querySelectorAll('.grade-bar').forEach(function(bar){
          bar.addEventListener('click', function(e){
            var b = e.target.closest('.grade-btn');
            if (b) pick(bar, b.dataset.grade);
          });
          syncBar(bar);
        });
      }

      function initDiagnosis(){
        var sel = document.getElementById('diagnosis_select');
        var inp = document.getElementById('diagnosis_other');
        var hid = document.getElementById('diagnosis');
        function update(){
          var v = sel.value;
          if (v === 'Other') {
            inp.style.display = '';
            hid.value = (inp.value || '').trim();
          } else {
            inp.style.display = 'none';
            hid.value = v || '';
          }
        }
        sel.addEventListener('change', update);
        inp.addEventListener('input', update);
        update();
      }

      function initTabs(){
        const btns = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = Array.from(document.querySelectorAll('.tab-panel'));
        btns.forEach(b=>{
          b.addEventListener('click', ()=>{
            btns.forEach(x=>x.setAttribute('aria-selected','false'));
            panels.forEach(p=>p.classList.remove('active'));
            b.setAttribute('aria-selected','true');
            const id = b.getAttribute('aria-controls');
            const panel = document.getElementById(id);
            if (panel) panel.classList.add('active');
          });
        });
      }

      function setDefaultNo(id){
        var el = document.getElementById(id);
        if (el && !el.value) el.value = 'No';
      }
      function initDefaults(){
        setDefaultNo('hospitalization_due_tox');
        setDefaultNo('delay');
        setDefaultNo('stop');
        setDefaultNo('dose_modification');
        setDefaultNo('toxicity_found');
      }

      function setGrade(targetId, grade){
        var sel = document.getElementById(targetId);
        if (!sel) return;
        sel.value = grade;
        sel.dispatchEvent(new Event('input', {bubbles:true}));
        sel.dispatchEvent(new Event('change', {bubbles:true}));
        var bar = document.querySelector('.grade-bar[data-target="'+targetId+'"]');
        if (bar) bar.querySelectorAll('.grade-btn').forEach(function(btn){ btn.classList.toggle('active', btn.dataset.grade===grade); });
      }
      function setBarsDisabled(disabled){
        document.querySelectorAll('.grade-bar').forEach(function(bar){
          bar.classList.toggle('disabled', disabled);
        });
      }
      function initFoundLock(){
        var found = document.getElementById('toxicity_found');
        var handler = function(){
          if (found.value === 'No'){
            setGrade('mucositis_grade','G0');
            setGrade('diarrhea_grade','G0');
            setGrade('neutropenia_grade','G0');
            setBarsDisabled(true);
          } else if (found.value === 'Yes'){
            setBarsDisabled(false);
          } else { setBarsDisabled(false); }
        };
        found.addEventListener('change', handler);
        handler();
      }

      function initNextFollowupQuick(){
        var inp = document.getElementById('followup_due');
        if (!inp) return;
        function addDays(d, n){ var x = new Date(d); x.setDate(x.getDate()+n); return x; }
        function toYMD(d){ var p=(n)=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate()); }
        document.querySelectorAll('[data-nw]').forEach(function(btn){
          btn.addEventListener('click', function(){
            var weeks = parseInt(btn.getAttribute('data-nw'),10)||1;
            var d = new Date();
            var out = toYMD(addDays(d, weeks*7));
            inp.value = out;
            inp.dispatchEvent(new Event('change', {bubbles:true}));
          });
        });
      }

      document.addEventListener('DOMContentLoaded', function(){
        initBars();
        initDiagnosis();
        initTabs();
        initDefaults();
        initFoundLock();
        initNextFollowupQuick();
      });
    })();
  </script>

  <!-- ===== Ø­ÙØ¸ Ø­Ø¬Ù… Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø¬ÙŠÙ… + Ù…ÙŠØ²Ø© Ø³Ø­Ø¨ saved-card ===== -->
  <script>
    (function(){
      /* ===== (1) Ø§Ø³ØªØ¹Ø§Ø¯Ø©/Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø¹Ù†Ø§ØµØ± .resizable ===== */
      var resizableEls = document.querySelectorAll('.resizable[data-resize-key]');
      resizableEls.forEach(function(el){
        var key = el.getAttribute('data-resize-key');
        try {
          var saved = JSON.parse(localStorage.getItem(key) || '{}');
          if (saved && typeof saved === 'object') {
            if (saved.w) el.style.width  = saved.w + 'px';
            if (saved.h) el.style.height = saved.h + 'px';
          }
        } catch(e){}
      });
      if (window.ResizeObserver) {
        var ro = new ResizeObserver(function(entries){
          for (var i=0;i<entries.length;i++){
            var t = entries[i].target;
            var key = t.getAttribute('data-resize-key');
            if (!key) continue;
            var rect = t.getBoundingClientRect();
            localStorage.setItem(key, JSON.stringify({
              w: Math.round(rect.width),
              h: Math.round(rect.height)
            }));
          }
        });
        resizableEls.forEach(function(el){ ro.observe(el); });
      }

      /* ===== (2) Drag-move Ù…Ø®ØµØµ Ù„Ù€ #saved-card ÙÙ‚Ø· ===== */
      var card   = document.getElementById('saved-card');
      var handle = document.getElementById('saved-drag-handle');
      var posKey = card && card.getAttribute('data-pos-key') || 'saved-card-pos';
      var container = document.querySelector('main.container');

      if (!card || !handle || !container) return;

      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ÙˆØ¶Ø¹ Ù…Ø­ÙÙˆØ¸ Ø¥Ù† ÙˆÙØ¬Ø¯
      try{
        var p = JSON.parse(localStorage.getItem(posKey) || '{}');
        if (typeof p === 'object' && Number.isFinite(p.left) && Number.isFinite(p.top)){
          card.classList.add('drag-abs');
          card.style.left = p.left + 'px';
          card.style.top  = p.top  + 'px';
        }
      }catch(_){}

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      function startDrag(clientX, clientY){
        card.classList.add('drag-abs','dragging');

        // Ø«Ø¨Ù‘Øª Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¹Ø¯Ù… ØªØºÙŠÙ‘Ø±Ù‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø·Ù„Ù‚
        var rect = card.getBoundingClientRect();
        var crect = container.getBoundingClientRect();

        // Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙØ·Ù„Ù‚Ø© Ø¨Ø¹Ø¯ØŒ Ø¹ÙŠÙ‘Ù† Ù…ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ©
        if (!card.style.left) card.style.left = (rect.left - crect.left) + 'px';
        if (!card.style.top)  card.style.top  = (rect.top  - crect.top)  + 'px';
        card.style.width  = rect.width + 'px'; // ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
        // (Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙŠØ¨Ù‚Ù‰ Ø­Ø³Ø¨ Ù…Ø­ØªÙˆÙ‰/resize)

        var start = {
          x: clientX,
          y: clientY,
          left: parseFloat(card.style.left)||0,
          top:  parseFloat(card.style.top)||0,
          cw: crect.width,
          ch: crect.height,
          w: rect.width,
          h: rect.height
        };

        function onMove(e){
          var cx = (e.touches ? e.touches[0].clientX : e.clientX);
          var cy = (e.touches ? e.touches[0].clientY : e.clientY);
          var dx = cx - start.x;
          var dy = cy - start.y;

          // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€container
          var maxLeft = start.cw - start.w;
          var maxTop  = start.ch - start.h;
          var newLeft = clamp(start.left + dx, 0, Math.max(0, maxLeft));
          var newTop  = clamp(start.top  + dy, 0, Math.max(0, maxTop));

          card.style.left = newLeft + 'px';
          card.style.top  = newTop  + 'px';
        }

        function onEnd(){
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onEnd);
          document.removeEventListener('touchmove', onMove, {passive:false});
          document.removeEventListener('touchend', onEnd);

          card.classList.remove('dragging');

          // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¶Ø¹
          var left = parseFloat(card.style.left)||0;
          var top  = parseFloat(card.style.top)||0;
          localStorage.setItem(posKey, JSON.stringify({ left:left, top:top }));
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive:false});
        document.addEventListener('touchend', onEnd);
      }

      handle.addEventListener('mousedown', function(e){ e.preventDefault(); startDrag(e.clientX, e.clientY); });
      handle.addEventListener('touchstart', function(e){
        var t = e.touches && e.touches[0]; if (!t) return;
        startDrag(t.clientX, t.clientY);
      }, {passive:true});

      // Ø¯Ø¨Ù„ ÙƒÙ„ÙŠÙƒ Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØ§Ø±Ø¯ Ù„Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      handle.addEventListener('dblclick', function(){
        card.classList.remove('drag-abs');
        card.style.left = card.style.top = card.style.width = '';
        localStorage.removeItem(posKey);
      });
    })();
  </script>
</body>
</html>
